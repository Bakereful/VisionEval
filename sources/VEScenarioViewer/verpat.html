<!DOCTYPE html>
<html lang='en'>

<head>

    <meta charset='utf-8'>
    
    <title>Scenario Viewer</title>

    <!-- 
    LOAD REQUIRED JAVASCRIPT LIBRARIES 
    -->
    <script src='js/d3.min.js' ></script>
    <script src='js/crossfilter.min.js' ></script>
    <script src='js/dc.min.js' ></script>
    <script src='js/jquery-1.10.2.js' ></script>
    <script src='js/bootstrap.min.js' ></script>
    <script src='js/colorbrewer.js' ></script>

    <!-- 
    SET STYLES 
    -->
    <link href='css/bootstrap.min.css' rel='stylesheet' type='text/css' >
    <link href='css/dc.css' rel='stylesheet' type='text/css' >
    <link href='css/colorbrewer.css' rel='stylesheet' type='text/css' >
    <style>
        h5 span {
            font-size: 14px;
            }
        .pietitle {
            font-weight: bold;
            }
        .bartitle {
            font-weight: bold;
            }
        .subtitle {
            font: 11px;
            color: grey;
            }
        .stat {
            font: 11 px;
            font-weight: bold;
            color: black;
            }
        .info {
            cursor: url(img/info.png), auto;
            }
        .readme {
            float:right;
            }
        .pie-slice text {
            font-size: 11px;
            fill: black;
            }
        .pop-crsr {
            cursor:help    
            }
        .stack._1 > .bar {
            fill:#ccc;
            }
        .dc-chart rect.deselected {
            fill: darkgrey;
        }
        .glyphicon {
            color: darkgray;
        }
    </style>

    <!-- 
    INITIALIZE POPOVERS THAT DISPLAY INFORMATION WHEN HOVERING ON PIE CHART AND BAR CHART TITLES 
    -->
    <script>
        $(function ()
          { $("#scen0-popover").popover({ 
              trigger: "hover",
              html: true,
              content: function() {
                  return $('#scen0-popover-content').html();
              }
            });
          });
        $(function ()
          { $("#scen5-popover").popover({ 
              trigger: "hover",
              html: true,
              content: function() {
                  return $('#scen5-popover-content').html();
              }
            });
          });
        $(function ()
          { $("#scen1-popover").popover({ 
              trigger: "hover",
              html: true,
              content: function() {
                  return $('#scen1-popover-content').html();
              }
            });
          });
        $(function ()
          { $("#scen2-popover").popover({ 
              trigger: "hover",
              html: true,
              content: function() {
                  return $('#scen2-popover-content').html();
              }
            });
          });
        $(function ()
          { $("#scen3-popover").popover({ 
              trigger: "hover",
              html: true,
              content: function() {
                  return $('#scen3-popover-content').html();
              }
            });
          });
        $(function ()
          { $("#scen4-popover").popover({ 
              trigger: "hover",
              html: true,
              content: function() {
                  return $('#scen4-popover-content').html();
              }
            });
          });
        $(function ()
          { $("#crashes-popover").popover({ 
              trigger: "hover",
              html: true,
              content: function() {
                  return $('#crashes-popover-content').html();
              }
            });
          });
        $(function ()
          { $("#cost-popover").popover({ 
              trigger: "hover",
              html: true,
              content: function() {
                  return $('#cost-popover-content').html();
              }
            });
          });
        $(function ()
          { $("#dvmt-popover").popover({ 
              trigger: "hover",
              html: true,
              content: function() {
                  return $('#dvmt-popover-content').html();
              }
            });
          });
        $(function ()
          { $("#emissions-popover").popover({ 
              trigger: "hover",
              html: true,
              content: function() {
                  return $('#emissions-popover-content').html();
              }
            });
          });
        $(function ()
          { $("#fuel-popover").popover({ 
              trigger: "hover",
              html: true,
              content: function() {
                  return $('#fuel-popover-content').html();
              }
            });
          });
        $(function ()
          { $("#time-popover").popover({ 
              trigger: "hover",
              html: true,
              content: function() {
                  return $('#time-popover-content').html();
              }
            });
          });
    </script>
    
</head>

<body>
 
    <!-- 
    SET UP HEADING AND BUTTONS TO SHOW QUICK START AND DETAILED EXPLANATION BOOTSTRAP MODALS 
    -->
    <div style="text-align:center">
      <h2>VERPAT Scenario Viewer</h2>
    </div>
    <div style="text-align:center">
      <button class="btn btn-primary btn-lg" data-toggle="modal" data-target="#about-modal">
          About
      </button>
      <button class="btn btn-primary btn-lg" data-toggle="modal" data-target="#quick-start-modal">
          Quick Start
      </button>
      <button class="btn btn-primary btn-lg" data-toggle="modal" data-target="#detail-modal">
          Detailed Instructions
      </button>
    </div>
  
    <!-- 
    ABOUT THIS EFFORT BOOTSTRAP MODAL 
    -->
    <div class="modal fade" id="about-modal" tabindex="-1" role="dialog" aria-labelledby="about-label" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h3 class="modal-title" id="about-label">About</h3>
            </div>
            <div class="modal-body">
                <h3>About the Scenario Viewer</h3>
                <p>
                This web page enables you to explore the results of multiple VERPAT model runs for sensitivity testing purposes. With it, you can select different combinations of input factors and find out how various future outcomes are affected by your selection. You can also select desired outcomes and find out what factors cause those outcomes to occur. By experimenting with the selections and observing the results, you will get a better understanding of the relationships between policy choices and context factors and future outcomes.
                </p>
                <h3>Copyright, Attribution and Acknowlegements</h3>
                <p>
                Copyright 2014-2015 Oregon Department of Transportation, 2018 AASHTO
                </p>
                <p>
                Licensed under the <a href="http://www.apache.org/licenses/LICENSE-2.0" target="_blank">Apache License, Version 2.0</a> (the "License"); you may not use this file except in compliance with the License.
                <p>Author(s): Brian Gregor (gregor@or-analytics.com), Ben Stabler (ben.stabler@rsginc.com), Aditya Gore (aditya.gore@rsginc.com).</p>
                <p>Many thanks go to the authors of the d3.js, dc.js, crossfilter.js, bootstrap.js, jquery.js, and colorbrewer.js libraries without which this data visualization would have been much more challenging to develop.</p>
             </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            </div>
            </div>
        </div>
    </div>

    <!-- 
    QUICK START BOOTSTRAP MODAL 
    -->
    <div class="modal fade" id="quick-start-modal" tabindex="-1" role="dialog" aria-labelledby="quick-start-label" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h3 class="modal-title" id="quick-start-label">Scenario Viewer Quick Start Guide</h3>
            </div>
            <div class="modal-body">
                    <ul>
                        <li><h4>Select Scenarios</h4></li>
                            <ul>
                                <li><strong>Scenario Input Bar Charts</strong> - choose scenario input levels. Click on a bar to toggle between selection and deselection (dark gray color). More than one can be selected. When filtered out the total number of charts available is shown in light gray.</li>
                                <li><strong>Outcome Bar Charts</strong> - click and drag mouse to select desired range of outcome measure. Change a selected range by clicking in the middle and dragging to move the entire selection or by clicking and dragging handles at either end of the range.</li>
                            </ul>
                        <li><h4>View Results</h4></li>
                            <ul>
                                <li>Scenario Bar Charts represent the values of the selected scenarios</li>
                                <li>Table shows attributes of the selected scenarios</li>
                            </ul>
                        <li><h4>Other</h4></li>
                        <ul>
                            <li>Reset button restores original selections</li>
                            <li>Mouse over bar chart titles for short descriptions</li>
                            <li>"Detailed Instructions" button gives further information</li>
                        </ul>
                    </ul>
             </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            </div>
            </div>
        </div>
    </div>
    
    <!-- 
    DETAILED EXPLANATION BOOTSTRAP MODAL 
    -->
    <div class="modal fade" id="detail-modal" tabindex="-1" role="dialog" aria-labelledby="detail-label" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h3 class="modal-title" id="detail-label">Detailed Instructions</h3>
            </div>
            <div class="modal-body">
                <h3>Categories</h3>
                <p>Many factors such as parking pricing and transit supply affect light duty vehicle travel. Because the number of factors considered is large, they were grouped into 6 categories as follows:</p>
                <ul>
                    <li><strong>Bicycles</strong> The diversion of single-occupant vehicle travel to bicycles, electric bicycles and other light-weight vehicles.</li>
                    <li><strong>Demand Management</strong> Programs and incentives which encourage people to drive less including ridesharing, van pooling, telecommuting, and transit subsidies.</li>
                    <li><strong>Land Use</strong> The form in which development occurs (density, regional accessibility, mixed use, etc.) represented by the distribution of population and employment by place type.</li>
                <li><strong>Parking</strong> The extent of paid parking and its price.</li>
                <li><strong>Transit</strong> The extent and frequency of transit service.</li>
                <li><strong>Vehicle Travel Cost</strong> The combination of fuel prices and vehicle travel charges to pay for roadways and to pay for externalities such as carbon pricing.</li>
                </ul>        
                <h3>Levels</h3>
                <p>Several levels were defined for each of the categories. These levels are numbered to indicate the amount of change from a <em>reference case</em> which represents the continuation of adopted local plans, policies and trends.</p>
                <ul>
                    <li><strong>Level 1:</strong> Corresponds to current conditions.</li>
                    <li><strong>Levels 2-3:</strong> Representing more ambitious policies.</li>
                </ul>
                <p>The levels are displayed in scenario bar charts, one for each category, as shown in the following illustration.</p>
                <img src="img/verpat-barchartscen.png" width="95%">
                <p>The sizes of the bars show the proportions of the selected scenarios in each each level.  The number of selected scenarios in each level is shown in the corresponding bar.  You can select (or deselect) the scenarios in a level by either clicking on the bar.  The selected level is colored and the non-selected levels are <em>grayed-out</em>. The total count of unfiltered scenarios is shown in light gray.</p>
                <h3>Outcomes</h3>
                <p>Given the chosen category inputs, the web page also shows future year outcomes for the following performance measures:</p>
                <ul>
                    <li><strong>Fatalities & Injuries:</strong> annual traffic fatalities and injuries per 1000 persons.</li>
                    <li><strong>Vehicle Cost Per Capita:</strong> average annual cost for owning & operating vehicles per person.</li>
                    <li><strong>DVMT Per Capita:</strong> average daily vehicle miles traveled per person.</li>
                    <li><strong>GHG Emissions Per Capita:</strong> average annual metric tons of greenhouse gas emissions per person.</li>
                    <li><strong>Fuel Consumption:</strong> average annual gallons of gasoline and other fuels consumed per person.</li>
                    <li><strong>DVHT Per Capita:</strong> average daily vehicle hours of travel per person.</li>
                </ul>        
                <p>Each outcome is illustrated in a bar chart showing the range of outcome values for the selected scenarios.  The bar height indicates the number of selected scenarios with that outcome value. The average value for all of the selected scenarios is shown above the bar chart.  The following illustrations shows what the <em>Fatalities & Injuries</em>, <em>Vehicle Cost Per Capita</em>, and <em>DVMT Per Capita</em> bar charts look like when all scenarios are selected.</p>
                <img src="img/verpat-barchart1.png" width="95%">
                <p>The bar charts can also be used to make a selection of scenarios.  This can be done by hovering the mouse cursor over the bar at one end of the desired selection range.  When the cursor is in the shape of a crosshairs, click and drag the mouse cursor to the other end of the desired range.  The bar chart will change to show the selected range.  In addition, handles will appear at the ends of the selected range.  You can click one these and drag it to alter the selection.  You can also click on the middle of the selection (when the shape of the cursor is a crossed arrow) to drag the whole selection to a different location on the bar chart.  As you make a selection in one bar chart, all the other bar charts will change to show just the selected scenarios.  The scenario bar charts will also change accordingly.  The following illustration shows a selection made on the <em>Fatalities & Injuries</em> bar chart and the corresponding values for the other bar charts in the row.  You can see in the picture the crossed-arrow cursor shape which means that the whole selection can be dragged to a new position.</p>
                <img src="img/verpat-barchart2.png" width="95%">
                <p>Selections can be made simultaneously on multiple scenario bar charts and outcome bar charts.  As more selections are made, all of the charts will be updated to show the selections that meet all of the selection conditions.  To clear all of the selections and show all of the scenarios, just click on one of the <em>Clear All Selections</em> links on the web page.</p>
                <h3>Selected Scenario Table</h3>
                <p>Finally, at the bottom of the web page is a table which shows the data for the selected scenarios.  The values in this table can be copied and saved in a spreadsheet.  To select the data to copy, double-click in the top left-hand cell, press the <em>Shift</em> key, and then click in the bottom right-hand cell.  Once the data has been selected, copy it by pressing the <em>Ctrl c</em> keys for a Windows computer or the <em>Command c</em> keys for an Apple Macintosh computer.  Paste as unicode text into the spreadsheet of your choice.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            </div>
            </div>
        </div>
    </div>
    
    <!-- 
    SET UP PIE CHART DISPLAYS OF CATEGORIES 
    -->
    <div class='container'>
        <!-- HEADING AND RESET LINK -->
        <div class='row'>
            <h3>
                <span>Scenario Input Levels</span>
                <span><a href="javascript:history.go(0)"> | Clear All Selections</a></span> <!-- RESET BY RELOADING PAGE -->
            </h3>
        </div>
        <!-- INPUT CATEGORY PIE CHARTS -->
        <div class='row'>
            <div class='span2 pietitle' id='Scenario0' >
                <div>
                <h5 class='text-center'><span class='pietitle pop-crsr' id='scen0-popover'></span></h5>
                </div>
                <div id='scen0-popover-content' style='display: none'>                                                     
                                                                         
                </div>
            </div>
            <div class='span2 pietitle' id='Scenario1'>
                <div>
                <h5 class='text-center'><span class='pietitle pop-crsr' id='scen1-popover'></span></h5>
                </div>
                <div id='scen1-popover-content' style='display: none'>                                                                      
                </div>
            </div>
            <div class='span2 pietitle' id='Scenario2'>
                <div>
                <h5 class='text-center'><span class='pietitle pop-crsr' id='scen2-popover'></span></h5>
                </div>
                <div id='scen2-popover-content' style='display: none'>                                                        
                </div>
            </div>
            <div class='span2 pietitle' id='Scenario3'>
                <div>
                <h5 class='text-center'><span class='pietitle pop-crsr' id='scen3-popover'></span></h5>
                </div>
                <div id='scen3-popover-content' style='display: none'>                                                       
                </div>
            </div>
            <div class='span2 pietitle' id='Scenario4'>
                <div>
                <h5 class='text-center'><span class='pietitle pop-crsr' id='scen4-popover'></span></h5>
                </div>
                <div id='scen4-popover-content' style='display: none'>                                                                        
                </div>
            </div>
            <div class='span2 pietitle' id='Scenario5'>
                <div>
                <h5 class='text-center'><span class='pietitle pop-crsr' id='scen5-popover'></span></h5>
                </div>
                <div id='scen5-popover-content' style='display: none'>                                                          
                </div>
            </div>
        </div>
    </div>

    <!-- 
    SET UP BAR CHART DISPLAYS OF OUTPUTS 
    -->
    <div class='container'>
        <!-- HEADING AND RESET LINK -->
        <div class='row'>
            <h3>
                <span>Model Outputs:</span>
                <span class="num-selected-scenarios">
                    <span class="filter-count" id="filter"></span>
                    scenarios selected out of
                    <span class="total-count" id="total"></span>
                    scenarios |
                    <a href="javascript:history.go(0)">Clear All Selections</a>
                </span>
             </h3>
        </div>
        <!-- 1ST ROW OF OUTPUT MEASURE BAR CHARTS -->
        <div class='flex-container' display="flex" flex-direction="row">
            <div class='span4' id='Crashes'>
                <div>
                <h5 class='text-center'><span class='bartitle pop-crsr' id='crashes-popover'>Fatalities & Injuries<span class="glyphicon glyphicon-info-sign"></span></span></h5>
                <h5 class='text-center'><span class='subtitle'>Average = <span id='Fatalities-Injuries' class='stat'></span> annual per 1000 pop</span></h5>
                </div>
                <div id='crashes-popover-content' style='display: none'>
                    <p><strong>Fatalities & Injuries:</strong> Annual traffic fatalities and injuries per 1000 pop</p>                                                            
                </div>
            </div>
            <div class='span4' id='Cost'>
                <div>
                <h5 class='text-center'><span class='bartitle pop-crsr' id='cost-popover'>Vehicle Cost Per Capita<span class="glyphicon glyphicon-info-sign"></span></span></h5>
                <h5 class='text-center'><span class='subtitle'>Average = <span id='Ave-Cost' class='stat'></span> annual per capita</span></h5>
                </div>
                <div id='cost-popover-content' style='display: none'>
                    <p><strong>Cost Per Capita:</strong> annual vehicle costs per capita.</p>                                                            
                </div>
            </div>
            <div class='span4' id='Dvmt'>
                <div>
                <h5 class='text-center'><span class='bartitle pop-crsr' id='dvmt-popover'>DVMT Per Capita<span class="glyphicon glyphicon-info-sign"></span></span></h5>
                <h5 class='text-center'><span class='subtitle'>Average = <span id='Ave-Dvmt' class='stat'></span> daily per capita</span></h5>
                </div>
                <div id='dvmt-popover-content' style='display: none'>
                    <p><strong>Daily Vehicle Miles Traveled:</strong> daily miles of vehicle travel per person.</p>                                                            
                </div>
            </div>
         </div>
        <!-- 2ND ROW OF OUTPUT MEASURE BAR CHARTS -->
        <div class='row'>
            <div class='span4' id='Emissions'>
                <div>
                <h5 class='text-center'><span class='bartitle pop-crsr' id='emissions-popover'>GHG Emissions Per Capita<span class="glyphicon glyphicon-info-sign"></span></span></h5>
                <h5 class='text-center'><span class='subtitle'>Average = <span id='Ave-Emissions' class='stat'></span> annual per capita</span></h5>
                </div>
                <div id='emissions-popover-content' style='display: none'>
                    <p><strong>GHG Emissions:</strong> annual metric tons greenhouse gas emissions per capita.</p>                                                            
                </div>
            </div>
             <div class='span4' id='Fuel'>
                <div>
                <h5 class='text-center'><span class='bartitle pop-crsr' id='fuel-popover'>Fuel Consumption<span class="glyphicon glyphicon-info-sign"></span></span></h5>
                <h5 class='text-center'><span class='subtitle'>Average = <span id='Ave-Fuel' class='stat'></span> annual per capita</span></h5>
                </div>
                <div id='fuel-popover-content' style='display: none'>
                    <p><strong>Fuel Consumption:</strong> average annual gallons of fuel consumed per capita.</p>                                                            
                </div>
            </div>
            <div class='span4' id='Time'>
                <div>
                <h5 class='text-center'><span class='bartitle pop-crsr' id='time-popover'>DVHT Per Capita<span class="glyphicon glyphicon-info-sign"></span></span></h5>
                <h5 class='text-center'><span class='subtitle'>Average = <span id='Ave-VHT' class='stat'></span> daily per capita</span></h5>
                </div>
                <div id='time-popover-content' style='display: none'>
                    <p><strong>Vehicle Hours of Travel:</strong> daily vehicle hours of travel per capita.</p>                                                            
                </div>
            </div>
       </div>
    </div>

    
    <!-- 
    SET UP OUTPUT TABLE
    -->
    <div class='container' style='font: 12px sans-serif;'>
        <div class='row'>
            <h3>Scenario Data Table</h3>
        </div>
        <div class='row'>
            <div class='span12'>
                <table class='table table-hover' id='Scenario-Results'>
                    <thead>
                        <tr class='header'>
                            <th>Bicycles</th>
                            <th>Demand Management</th>
                            <th>Land Use</th>
                            <th>Parking</th>
                            <th>Transit</th>
                            <th>Vehicle Travel Cost</th>
                            <th>Fatalities/Injuries</th>
                            <th>Vehicle Cost</th>
                            <th>DVMT</th>
                            <th>GHG Emissions</th>
                            <th>Fuel</th>
                            <th>DVHT</th>
                        </tr>
                   </thead>
                </table>
            </div>
        </div>
    </div>


    <!--
    SETUP THE UI FROM CONFIG FILE
    -->
    <script src='data/verpat-cfg.js' type='text/javascript'></script>
    <script>
        var configdata = config;
        $.each(configdata,function(index,values) {
            var scenarioName = values.NAME;
            var scenarioLabel = values.LABEL;
            var scenarioDescription = values.DESCRIPTION;
            var scenarioInstruct = values.INSTRUCTIONS;
            var scenarioLevels = values.LEVELS;
            $('#scen' + index + '-popover').append(scenarioLabel+"<span class=\"glyphicon glyphicon-info-sign\"></span>");

            $('#scen' + index + '-popover-content').append('<p><strong>' + scenarioLabel + ':</strong> ' + scenarioDescription + '</p>');
            $.each(scenarioLevels, function (key, value) {
                $('#scen' + index + '-popover-content').append('<p><strong>Level ' + value.NAME + ':</strong> ' + value.DESCRIPTION + '</p>');
            });
        });

    </script>





    <!-- 
    LOAD SCENARIO DATA AND REF MEASURES DATA
    -->
    <script src='data/verpat.js' type='text/javascript'></script>
    <!--
    <script src='data/verpat-ref.js' type="text/javascript"></script>
    --> 
  
    <!-- 
    JAVASCRIPT TO IMPLEMENT VISUALIZATION
    -->
    <script>

        // Identify the reference scenario values
        //---------------------------------------
        //var refValues = data2010[0];
                     
        // Establish the crossfilter
        //--------------------------
        var facts = crossfilter(data);
        
        // Set up all of the dc.js chart objects
        //--------------------------------------
        // Set up the pie chart objects to display scenario input levels
        var 
            scenarioBarChart0 = dc.barChart("#Scenario0"),
            scenarioBarChart5 = dc.barChart("#Scenario5"),
            scenarioBarChart1 = dc.barChart("#Scenario1"),
            scenarioBarChart2 = dc.barChart("#Scenario2"),
            scenarioBarChart3 = dc.barChart("#Scenario3"),
            scenarioBarChart4 = dc.barChart("#Scenario4")
        ;
        // Set up the bar chart objects to display scenario output levels
        var 
            crashesBarChart = dc.barChart("#Crashes"),
            costBarChart = dc.barChart("#Cost"),
            dvmtBarChart = dc.barChart("#Dvmt"),
            emissionsBarChart = dc.barChart("#Emissions"),
            fuelBarChart = dc.barChart("#Fuel"),
            timeBarChart = dc.barChart("#Time")
        ;
        // Set up the number objects to display output averages
        var
            crashAveNum = dc.numberDisplay("#Fatalities-Injuries")
            costAveNum = dc.numberDisplay("#Ave-Cost"),
            dvmtAveNum = dc.numberDisplay("#Ave-Dvmt"),
            emissionsAveNum = dc.numberDisplay("#Ave-Emissions"),
            fuelAveNum = dc.numberDisplay("#Ave-Fuel"),
            timeAveNum = dc.numberDisplay("#Ave-VHT")
        ;
        // Set up table to display values for selected scenarios
        var scenarioTable = dc.dataTable("#Scenario-Results");
        // Set up display of total selected scenarios
        var all = facts.groupAll();
        dc.dataCount(".num-selected-scenarios")
            .dimension(facts)
            .group(all);
        
        
        // Establish a crossfilter dimensions for the scenario data
        //---------------------------------------------------------
        // Establish the scenario input dimensions to be displayed and filtered
        var 
            scenDim0 = facts.dimension( function(d) {return d.Bike;} ),
            scenDim5 = facts.dimension( function(d) {return d.VmtChrg;} ),
            scenDim1 = facts.dimension( function(d) {return d.DemandMgt;} ),
            scenDim2 = facts.dimension( function(d) {return d.LandUse;} ),
            scenDim3 = facts.dimension( function(d) {return d.Parking;} ),
            scenDim4 = facts.dimension( function(d) {return d.Transit;} )
        ;
        // Establish the scenario output dimensions to be displayed and filtered
        var 
            crashDim = facts.dimension( function(d) {return d.FatalityInjuryRate;} ),
            costDim = facts.dimension( function(d) {return d.AveCost;} ),
            dvmtDim = facts.dimension( function(d) {return d.AveDvmt;} ),
            emissionsDim = facts.dimension( function(d) {return d.AveEmissions;} ),
            fuelDim = facts.dimension( function(d) {return d.AveFuel;} ),
            timeDim = facts.dimension( function(d) {return d.AveVehHr;} )
        ;
        
        // Establish the group statistics to display
        //------------------------------------------
        // Establish the scenario input group statistics (counts) to be displayed as pie wedges
        var 
            scenGroup0 = scenDim0.group(),
            scenGroup5 = scenDim5.group(),
            scenGroup1 = scenDim1.group(),
            scenGroup2 = scenDim2.group(),
            scenGroup3 = scenDim3.group(),
            scenGroup4 = scenDim4.group()
        ;
        scenGroupWhole0 = scenGroup0.top(Infinity);
        scenGroupWhole1 = scenGroup1.top(Infinity);
        scenGroupWhole2 = scenGroup2.top(Infinity);
        scenGroupWhole3 = scenGroup3.top(Infinity);
        scenGroupWhole4 = scenGroup4.top(Infinity);
        scenGroupWhole5 = scenGroup5.top(Infinity);
        // Store the original group values into hash objects to re use 
        var 
            scen0_hash = {}, 
            scen1_hash = {}, 
            scen2_hash = {}, 
            scen3_hash = {}, 
            scen4_hash = {}
            scen5_hash = {};

        scenGroupWhole0.forEach( function(p,i) {
            scen0_hash[p.key] = p.value
        });
        scenGroupWhole1.forEach( function(p,i) {
            scen1_hash[p.key] = p.value
        });
        scenGroupWhole2.forEach( function(p,i) {
            scen2_hash[p.key] = p.value
        });
        scenGroupWhole3.forEach( function(p,i) {
            scen3_hash[p.key] = p.value
        });
        scenGroupWhole4.forEach( function(p,i) {
            scen4_hash[p.key] = p.value
        });
        scenGroupWhole5.forEach( function(p,i) {
            scen5_hash[p.key] = p.value
        });                                        

        // Establish the bin dimensions for bar charts (to be used in grouping)
        var measures = [ "FatalityInjuryRate", "AveCost", "AveDvmt", "AveEmissions", 
                        "AveFuel", "AveVehHr" ]
        var bins = {};
        var calcBinning = function(data, measure, nBins) {
            var xExtent = d3.extent(data, function(d) {return d[measure];});
            var xWidth = (xExtent[1] - xExtent[0]) / nBins;
            return { xExtent: xExtent, xWidth: xWidth };
        };
        for( var i=0; i<measures.length; i++ ) {
            bins[measures[i]] = calcBinning( data, measures[i], 15 );
        };
        // Establish the output group statistics (counts) to be displayed in bar charts
        var
            crashGroup = crashDim.group(function(d) {return Math.floor(d / bins.FatalityInjuryRate.xWidth) * bins.FatalityInjuryRate.xWidth;}),
            costGroup = costDim.group(function(d){return Math.floor(d / bins.AveCost.xWidth) * bins.AveCost.xWidth;}),
            dvmtGroup = dvmtDim.group(function(d){return Math.floor(d / bins.AveDvmt.xWidth) * bins.AveDvmt.xWidth;}),
            emissionsGroup = emissionsDim.group(function(d){return Math.floor(d / bins.AveEmissions.xWidth) * bins.AveEmissions.xWidth;}),
            fuelGroup = fuelDim.group(function(d){return Math.floor(d / bins.AveFuel.xWidth) * bins.AveFuel.xWidth;}),      
            timeGroup = timeDim.group(function(d){return Math.floor(d / bins.AveVehHr.xWidth) * bins.AveVehHr.xWidth;})
        ;
        // Define reduce functions to calculate output measure averages for filtered selections
        function addAvg(attr) {
            return function(p,v) {
                ++p.count
                p.sum += v[attr];
                p.avg = p.sum/p.count;
                //p.ref = refValues[attr];
                return p;
            };
        }
        function remAvg(attr) {
            return function(p,v) {
                --p.count
                p.sum -= v[attr];
                p.avg = p.sum/p.count;
                //p.ref = refValues[attr];
                return p;
            };
        }
        function iniAvg() {
            return {count:0, sum:0, avg:0}; //, ref:0};
        }
        // Establish the output group output measure averages
        var
            allDim = facts.dimension( function(d) {return Math.round(d.FatalityInjuryRate / d.FatalityInjuryRate);} ),
            crashAveGroup = allDim.group().reduce(addAvg("FatalityInjuryRate"), remAvg("FatalityInjuryRate"), iniAvg),
            costAveGroup = allDim.group().reduce(addAvg("AveCost"), remAvg("AveCost"), iniAvg),
            dvmtAveGroup = allDim.group().reduce(addAvg("AveDvmt"), remAvg("AveDvmt"), iniAvg),
            emissionsAveGroup = allDim.group().reduce(addAvg("AveEmissions"), remAvg("AveEmissions"), iniAvg),
            fuelAveGroup = allDim.group().reduce(addAvg("AveFuel"), remAvg("AveFuel"), iniAvg),      
            timeAveGroup = allDim.group().reduce(addAvg("AveVehHr"), remAvg("AveVehHr"), iniAvg)
        ;

        // Plot the input pie charts
        //--------------------------
        // Define layout variables that are common to all the pie charts
        var
            pieWidth = 185,
            pieHeight = 185,
            pieRadius = 60,
            pieInnerRadius = 20,
            pieMargins = {top: 10, right: 10, bottom: 10, left: 10}
        ;
        // Community category input levels

        scenarioBarChart0.width(pieWidth)
            .height(200)      
            .stack(18)
			.x(d3.scaleBand())
			.xUnits(dc.units.ordinal)
            .dimension(scenDim0)
            .group(scenGroup0)	
            .gap(10)
            .yAxisPadding('10%')
            .renderLabel(true)          
            .label(function (d){return "L" + d.data.key;})
            .title(function(d){
                     var id = d.key
                    if(this.layer=="Total Items") {
                    return "Total: "+ scen0_hash[id];
                }
                return "L"+d.key + ": "+ d.value;
                })
			.stack(scenGroup0, "Total Items",function(d) { 
               // if(d.value > 0 ){     //only add the stacked data to filtered bars that have data.
                    var id = d.key
                    return scen0_hash[id] - d.value; //only add the difference between the filter and totals
              //  }
            });           
       
            scenarioBarChart1.width(pieWidth)
                .height(200)
                .stack(18)
			    .x(d3.scaleBand())
			    .xUnits(dc.units.ordinal)
                .dimension(scenDim1)
                .group(scenGroup1)
                .gap(10)
                .yAxisPadding('10%')
                .renderLabel(true)
                .title(function(d){
                     var id = d.key
                    if(this.layer=="Total Items") {
                    return "Total: "+ scen1_hash[id];
                }
                return "L"+d.key + ": "+ d.value;
                })
                .label(function (d){return "L" + d.data.key;})
			    .stack(scenGroup1, "Total Items",function(d) {
              //  if(d.value > 0 ){     //only add the stacked data to filtered bars that have data.
                    var id = d.key
                    return scen1_hash[id] - d.value; //only add the difference between the filter and totals
            //    }
                });
            scenarioBarChart2.width(pieWidth)
                .height(200)
                .stack(18)
			    .x(d3.scaleBand())
			    .xUnits(dc.units.ordinal)
                .dimension(scenDim2)
                .group(scenGroup2)
                .gap(10)
                .yAxisPadding('10%')
                .renderLabel(true)
                .label(function (d){return "L" + d.data.key;})
                .title(function(d){
                     var id = d.key
                    if(this.layer=="Total Items") {
                    return "Total: "+ scen2_hash[id];
                }
                return "L"+d.key + ": "+ d.value;
                })
                .stack(scenGroup2, "Total Items",function(d) {
                    //    if(d.value > 0 ){     //only add the stacked data to filtered bars that have data.
                    var id = d.key
                    return scen2_hash[id] - d.value; //only add the difference between the filter and totals
                    //   }
                });
            scenarioBarChart3.width(pieWidth)
            .height(200)      
            .stack(18)
			.x(d3.scaleBand())
			.xUnits(dc.units.ordinal)
            .dimension(scenDim3)
            .group(scenGroup3)	
            .gap(10)
            .yAxisPadding('10%')
            .renderLabel(true)          
            .label(function (d){return "L" + d.data.key;})
            .title(function(d){
                 var id = d.key
                if(this.layer=="Total Items") {
                    return "Total: " + scen3_hash[id];
                }
                return "L"+d.key + ": "+ d.value;
                })
			.stack(scenGroup3, "Total Items",function(d) { 
            //    if(d.value > 0 ){     //only add the stacked data to filtered bars that have data.
                    var id = d.key
                    return scen3_hash[id] - d.value; //only add the difference between the filter and totals
             //   }
            });
            scenarioBarChart4.width(pieWidth)
            .height(200)      
            .stack(18)
			.x(d3.scaleBand())
			.xUnits(dc.units.ordinal)
            .dimension(scenDim4)
            .group(scenGroup4)	
            .gap(10)
            .yAxisPadding('10%')
            .renderLabel(true)          
            .label(function (d){return "L" + d.data.key;})
            .title(function(d){
                 var id = d.key
                    if(this.layer=="Total Items") {
                    return "Total: "+ scen4_hash[id];
                }
                return "L"+d.key + ": "+ d.value;
                })
			.stack(scenGroup4, "Total Items",function(d) { 
            //    if(d.value > 0 ){     //only add the stacked data to filtered bars that have data.
                    var id = d.key
                    return scen4_hash[id] - d.value; //only add the difference between the filter and totals
            //    }
            }); 
            scenarioBarChart5.width(pieWidth)
            .height(200)      
            .stack(18)
			.x(d3.scaleBand())
			.xUnits(dc.units.ordinal)
            .dimension(scenDim5)
            .group(scenGroup5)	
            .gap(10)
            .yAxisPadding('10%')
            .renderLabel(true)
            .title(function(d){
                 var id = d.key
                 if(this.layer=="Total Items") {
                    return "Total: "+ scen5_hash[id];
                }
                return "L"+d.key + ": "+ d.value;
                })
            .label(function (d){return "L" + d.data.key;})
			.stack(scenGroup5, "Total Items",function(d) { 
            //    if(d.value > 0 ){     //only add the stacked data to filtered bars that have data.
                    var id = d.key
                    return scen5_hash[id] - d.value; //only add the difference between the filter and totals
            //    }
            });                                                 
        // Plot the output bar charts
        //---------------------------
        // Define layout variables that are common to all the bar charts
        var
            barWidth = 260,
            barHeight = 140,
            barMargins = {top: 10, right: 10, bottom: 20, left: 25}
        ;
        // Traffic fatalities and injuries
        crashesBarChart.width(barWidth)
            .height(barHeight)
            .margins(barMargins)
            .dimension(crashDim)
            .group(crashGroup)
            .transitionDuration(200)
            .centerBar(true)
            .gap(40)
            .brushOn(true)
            .x(d3.scaleLinear().domain(bins.FatalityInjuryRate.xExtent))
            .elasticY(true)
            .yAxisLabel("# Scenarios")
            .xAxis().tickFormat();
        crashesBarChart.xAxis().ticks(5);
        crashesBarChart.yAxis().ticks(5);
        crashesBarChart.xUnits(function(){return 4.8;});
        // Average per capita vehicle cost
        costBarChart.width(barWidth)
            .height(barHeight)
            .margins(barMargins)
            .dimension(costDim)
            .group(costGroup)
            .transitionDuration(200)
            .centerBar(true)
            .gap(40)
            .x(d3.scaleLinear().domain(bins.AveCost.xExtent))
            .elasticY(true)
            .xAxis().tickFormat();
        costBarChart.xAxis().ticks(5);        
        costBarChart.yAxis().ticks(5);
        costBarChart.xUnits(function(){return 4.8;});
        // Average per capita daily vehicle miles of travel
        dvmtBarChart.width(barWidth)
            .height(barHeight)
            .margins(barMargins)
            .dimension(dvmtDim)
            .group(dvmtGroup)
            .transitionDuration(200)
            .centerBar(true)
            .gap(40)
            .x(d3.scaleLinear().domain(bins.AveDvmt.xExtent))
            .elasticY(true)
            .xAxis().tickFormat();
        dvmtBarChart.xAxis().ticks(5);        
        dvmtBarChart.yAxis().ticks(5);
        dvmtBarChart.xUnits(function(){return 4.8;});
        // Average annual greenhouse gas emissions per capita
        emissionsBarChart.width(barWidth)
            .height(barHeight)
            .margins(barMargins)
            .dimension(emissionsDim)
            .group(emissionsGroup)
            .transitionDuration(200)
            .centerBar(true)
            .gap(40)
            .x(d3.scaleLinear().domain(bins.AveEmissions.xExtent))
            .elasticY(true)
            .xAxis().tickFormat();
        emissionsBarChart.xAxis().ticks(5);        
        emissionsBarChart.yAxis().ticks(5);
        emissionsBarChart.xUnits(function(){return 4.8;});
        // Average gallons of fuel consumed per person    
        fuelBarChart.width(barWidth)
            .height(barHeight)
            .margins(barMargins)
            .dimension(fuelDim)
            .group(fuelGroup)
            .transitionDuration(200)
            .centerBar(true)
            .gap(105)
            .x(d3.scaleLinear().domain(bins.AveFuel.xExtent))
            .elasticY(true)
            .yAxisLabel("# Scenarios")
            .xAxis().tickFormat();
        fuelBarChart.xAxis().ticks(5);        
        fuelBarChart.yAxis().ticks(5);
        fuelBarChart.xUnits(function(){return 2.65;});
        // Average daily vehicle hours of travel per person
        timeBarChart.width(barWidth)
            .height(barHeight)
            .margins(barMargins)
            .dimension(timeDim)
            .group(timeGroup)
            .transitionDuration(200)
            .centerBar(true)
            .gap(40)
            .x(d3.scaleLinear().domain(bins.AveVehHr.xExtent))
            .elasticY(true)
            .xAxis().tickFormat();
        timeBarChart.xAxis().ticks(5);        
        timeBarChart.yAxis().ticks(5);
        timeBarChart.xUnits(function(){return 4.8;});

        // Display the average values for outputs
        //---------------------------------------
        crashAveNum.group(crashAveGroup).valueAccessor(function(p) {return p.value.avg;});
        costAveNum.group(costAveGroup).valueAccessor(function(p) {return p.value.avg;});
        dvmtAveNum.group(dvmtAveGroup).valueAccessor(function(p) {return p.value.avg;});
        emissionsAveNum.group(emissionsAveGroup).valueAccessor(function(p) {return p.value.avg;});
        fuelAveNum.group(fuelAveGroup).valueAccessor(function(p) {return p.value.avg;});
        timeAveNum.group(timeAveGroup).valueAccessor(function(p) {return p.value.avg;});
        
        // Display the scenario data table for the top 10 scenarios
        //---------------------------------------------------------
        scenarioTable.width(960).height(800)
            .dimension(crashDim)
            .group(function(d) {return "";})
            .columns([
                function(d) {return d.Bike;},
                function(d) {return d.DemandMgt;},
                function(d) {return d.LandUse;},
                function(d) {return d.Parking;},
                function(d) {return d.Transit;},
                function(d) {return d.VmtChrg;},
                function(d) {return d.FatalityInjuryRate;},
                function(d) {return d.AveCost;},
                function(d) {return d.AveDvmt;},
                function(d) {return d.AveEmissions;},
                function(d) {return d.AveFuel;},
                function(d) {return d.AveVehHr;},
            ])
            .sortBy(function(d) {return d.AveEmissions;})
            .order(d3.ascending)
            .size(500);

        // Render all of the graphic elements
        //-----------------------------------
        dc.renderAll(); 
        
    </script>
    
</body>

