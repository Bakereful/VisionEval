# R for travis: see documentation at https://docs.travis-ci.com/user/languages/r

language: R
sudo: true
cache: packages

# Be strict when checking our package
warnings_are_errors: false

before_install:
  - sudo apt-get update
  - sudo apt-get install libnlopt-dev


install:
  - Rscript -e 'install.packages(c("devtools", "roxygen2", "stringr", "knitr", "data.table", "curl"))'
  - Rscript -e 'install.packages(c("shiny", "shinyjs", "shinyFiles", "DT", "shinyBS", "future", "testit", "jsonlite", "shinyAce", "envDocument", "rhandsontable"))'
  - Rscript -e 'devtools::install_github(c("tdhock/namedCapture", "trestletech/shinyTree"))'
  - Rscript -e 'devtools::install_bioc(c("BiocInstaller", "rhdf5"))'

env:
  - TYPE=framework TEST_DIR=sources/framework/visioneval
  
  - TYPE=module    TEST_DIR=sources/modules/VE2001NHTS
  - TYPE=module    TEST_DIR=sources/modules/VEAltModes
  - TYPE=module    TEST_DIR=sources/modules/VELandUse
  - TYPE=module    TEST_DIR=sources/modules/VESimHouseholds
  - TYPE=module    TEST_DIR=sources/modules/VESyntheticFirms
  - TYPE=module    TEST_DIR=sources/modules/VETransportSupply
  - TYPE=module    TEST_DIR=sources/modules/VEVehicleOwnership
  
  - TYPE=model     TEST_DIR=sources/models/VERPAT
  - TYPE=model     TEST_DIR=sources/models/VERSPM/Test1
  
  - TYPE=gui       TEST_DIR=sources/VEGUI

script:
  - |
    if [ $TYPE = "module" ] || [ $TYPE = "framework" ] ; then
      cd $TEST_DIR;
      Rscript -e 'devtools::install_deps(".")';
      Rscript -e 'devtools::check(".")';
      Rscript -e "tryCatch( source('tests/scripts/test.R') )";
      
    elif [ $TYPE = "model" ] || [ $TYPE = "gui" ]; then
      cd sources/framework/visioneval;
      Rscript -e 'devtools::install_deps(".")';
      R CMD INSTALL .;
      cd ../../..;
      
      cd sources/modules/VE2001NHTS;
      Rscript -e 'devtools::install_deps(".")';
      R CMD INSTALL .;
      cd ../../..;
      
      cd sources/modules/VEAltModes;
      Rscript -e 'devtools::install_deps(".")';
      R CMD INSTALL .;
      cd ../../..;
      
      cd sources/modules/VELandUse;
      Rscript -e 'devtools::install_deps(".")';
      R CMD INSTALL .;
      cd ../../..;
      
      cd sources/modules/VESimHouseholds;
      Rscript -e 'devtools::install_deps(".")';
      R CMD INSTALL .;
      cd ../../..;
      
      cd sources/modules/VESyntheticFirms;
      Rscript -e 'devtools::install_deps(".")';
      R CMD INSTALL .;
      cd ../../..;
      
      cd sources/modules/VETransportSupply;
      Rscript -e 'devtools::install_deps(".")';
      R CMD INSTALL .;
      cd ../../..;
      
      cd sources/modules/VEVehicleOwnership;
      Rscript -e 'devtools::install_deps(".")';
      R CMD INSTALL .;
      cd ../../..;
      
      cd $TEST_DIR;
      if [ $TYPE = "model" ]; then
        Rscript -e "tryCatch( source('run_model.R') )";
        
      elif [ $TYPE = "gui" ]; then
        Rscript -e 'tryCatch( library("shiny"); runApp("app.R") )';
      fi
      
    fi
